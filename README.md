# TIC-Bot

åŸºäº Grammy æ¡†æ¶çš„ Telegram æœºå™¨äººé¡¹ç›® - ä¸“ä¸šçš„èµ„æ–™é‡‡é›†ç³»ç»Ÿ

## åŠŸèƒ½ç‰¹æ€§

- ğŸ¤– **æ™ºèƒ½èµ„æ–™é‡‡é›†**: æ”¯æŒåª’ä½“ç»„+éªŒè¯è§†é¢‘çš„å®Œæ•´èµ„æ–™æ”¶é›†æµç¨‹
- ğŸ’¾ **æ•°æ®åº“å­˜å‚¨**: MySQL æ•°æ®åº“æŒä¹…åŒ–å­˜å‚¨ï¼Œè‡ªåŠ¨ç”Ÿæˆèµ„æ–™ç¼–å·
- ğŸ“ **å®Œæ•´åé¦ˆæœºåˆ¶**: å®æ—¶çŠ¶æ€é€šçŸ¥ï¼Œè¶…æ—¶æé†’ï¼Œå®Œæˆç¡®è®¤
- ğŸ›¡ï¸ **é”™è¯¯å¤„ç†æœºåˆ¶**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œç”¨æˆ·æç¤º
- â° **è¶…æ—¶ç®¡ç†**: 60 ç§’è¶…æ—¶æœºåˆ¶ï¼Œè‡ªåŠ¨æ¸…ç†æœªå®Œæˆä¼šè¯
- ğŸ”„ **ä¼˜é›…å…³é—­**: æ”¯æŒä¼˜é›…çš„è¿›ç¨‹å…³é—­å’Œæ•°æ®åº“è¿æ¥æ¸…ç†

## ä¸šåŠ¡æµç¨‹

### ğŸ“¥ èµ„æ–™æäº¤æµç¨‹

1. **å‘é€åª’ä½“ç»„** - ç®¡ç†å‘˜å‘é€å›¾ç‰‡/è§†é¢‘/æ–‡æ¡£ç»„åˆ
2. **æ”¶åˆ°ç¡®è®¤** - æœºå™¨äººç¡®è®¤æ¥æ”¶ï¼Œæç¤ºä¸‹ä¸€æ­¥æ“ä½œ
3. **å‘é€éªŒè¯è§†é¢‘** - åœ¨ 60 ç§’å†…å‘é€éªŒè¯è§†é¢‘
4. **è·å¾—ç¼–å·** - ç³»ç»Ÿä¿å­˜åˆ°æ•°æ®åº“ï¼Œè¿”å›å”¯ä¸€èµ„æ–™ç¼–å·

### â° è¶…æ—¶å¤„ç†

- å¦‚æœ 60 ç§’å†…æœªæ”¶åˆ°éªŒè¯è§†é¢‘ï¼Œç³»ç»Ÿä¼šï¼š
  - å‘é€è¶…æ—¶æé†’
  - æ¸…ç†å½“å‰ä¼šè¯
  - æç¤ºé‡æ–°æäº¤æµç¨‹

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿ä½ çš„ç³»ç»Ÿå·²å®‰è£…ï¼š

- Node.js (â‰¥ 16.0.0)
- MySQL (â‰¥ 5.7)

### 2. å®‰è£…ä¾èµ–

```bash
npm install
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
cp .env.example .env
```

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ï¼š

```env
# Telegramæœºå™¨äººé…ç½®
BOT_TOKEN=ä½ çš„æœºå™¨äººtoken

# MySQLæ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=ä½ çš„æ•°æ®åº“å¯†ç 
DB_NAME=telegram_bot

# ä¸šåŠ¡é…ç½®
COLLECTION_TIMEOUT=60000
WAITING_NOTICE_INTERVAL=15000

# ç¯å¢ƒé…ç½®
NODE_ENV=development
```

> ğŸ’¡ ä» [@BotFather](https://t.me/BotFather) è·å–ä½ çš„æœºå™¨äºº Token

### 4. åˆå§‹åŒ–æ•°æ®åº“

```bash
# å¿«é€Ÿè®¾ç½®æ•°æ®åº“ï¼ˆæ¨èï¼‰
npm run setup-db

# æˆ–æ‰‹åŠ¨æ‰§è¡ŒSQLè„šæœ¬
mysql -u root -p < scripts/init-database.sql
```

### 5. è¿è¡Œé¡¹ç›®

#### å¼€å‘æ¨¡å¼ï¼ˆæ¨èï¼‰

```bash
npm run dev
```

#### ç”Ÿäº§æ¨¡å¼

```bash
# æ„å»ºé¡¹ç›®
npm run build

# å¯åŠ¨æœºå™¨äºº
npm start
```

## å¼€å‘æŒ‡å—

### é¡¹ç›®ç»“æ„

```
TIC-Bot/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ bot/
â”‚   â”‚   â””â”€â”€ bot.ts              # æœºå™¨äººä¸»é€»è¾‘
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ database.ts         # æ•°æ®åº“è¿æ¥å’Œæ“ä½œ
â”‚       â””â”€â”€ upload-session.ts   # ä¸Šä¼ ä¼šè¯ç®¡ç†
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ init-database.sql       # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”‚   â””â”€â”€ setup-database.js       # æ•°æ®åº“å¿«é€Ÿè®¾ç½®å·¥å…·
â”œâ”€â”€ dist/                       # æ„å»ºè¾“å‡ºç›®å½•
â”œâ”€â”€ docs/                       # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ .env.example               # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ .gitignore                # Gitå¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ package.json              # é¡¹ç›®é…ç½®
â”œâ”€â”€ tsconfig.json             # TypeScripté…ç½®
â””â”€â”€ README.md                 # é¡¹ç›®è¯´æ˜
```

### å¯ç”¨è„šæœ¬

```bash
npm run build      # ç¼–è¯‘TypeScriptä»£ç 
npm run dev        # å¼€å‘æ¨¡å¼ï¼ˆnodemon + tsxï¼šç›´æ¥è¿è¡ŒTypeScriptï¼Œæ— éœ€ç¼–è¯‘ï¼‰
npm run dev:direct # ç›´æ¥è¿è¡Œä¸€æ¬¡ï¼ˆtsxï¼šå¿«é€Ÿæµ‹è¯•ä»£ç ï¼‰
npm run dev:watch  # å¼€å‘æ¨¡å¼ï¼ˆtsc-watchï¼šç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨ç¼–è¯‘å¹¶è¿è¡Œï¼‰
npm run dev:build  # å¼€å‘æ¨¡å¼ï¼ˆä»…ç¼–è¯‘ç›‘å¬ï¼Œä¸è¿è¡Œï¼‰
npm start          # ç”Ÿäº§æ¨¡å¼è¿è¡Œ
npm run clean      # æ¸…ç†æ„å»ºæ–‡ä»¶
npm run setup-db   # å¿«é€Ÿè®¾ç½®æ•°æ®åº“
```

### æ•°æ®åº“ç»“æ„

#### resources è¡¨

| å­—æ®µ        | ç±»å‹               | è¯´æ˜             |
| ----------- | ------------------ | ---------------- |
| id          | INT AUTO_INCREMENT | èµ„æ–™ IDï¼ˆä¸»é”®ï¼‰  |
| user_id     | BIGINT             | ç”¨æˆ· Telegram ID |
| caption     | TEXT               | èµ„æ–™æ ‡é¢˜/æè¿°    |
| media_count | INT                | åª’ä½“æ–‡ä»¶æ•°é‡     |
| has_video   | BOOLEAN            | æ˜¯å¦åŒ…å«éªŒè¯è§†é¢‘ |
| media_files | JSON               | åª’ä½“æ–‡ä»¶ä¿¡æ¯     |
| video_file  | JSON               | éªŒè¯è§†é¢‘ä¿¡æ¯     |
| created_at  | TIMESTAMP          | åˆ›å»ºæ—¶é—´         |

### æŠ€æœ¯æ ˆ

- **TypeScript**: ä¸»è¦å¼€å‘è¯­è¨€
- **Grammy**: Telegram Bot æ¡†æ¶
- **MySQL2**: æ•°æ®åº“è¿æ¥é©±åŠ¨
- **Node.js**: è¿è¡Œç¯å¢ƒ
- **dotenv**: ç¯å¢ƒå˜é‡ç®¡ç†
- **tsx**: ç°ä»£ TypeScript è¿è¡Œå™¨ï¼ˆæ— éœ€ç¼–è¯‘ï¼‰
- **tsc-watch**: å¼€å‘æ—¶è‡ªåŠ¨ç¼–è¯‘å’Œçƒ­é‡è½½

### å¼€å‘ç‰¹æ€§

- âš¡ **é›¶ç¼–è¯‘å¼€å‘**: ä½¿ç”¨ `tsx` + `nodemon` ç›´æ¥è¿è¡Œ TypeScript ä»£ç 
- ğŸ”¥ **çƒ­é‡è½½**: æ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨é‡å¯ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–è¯‘
- ğŸ“¦ **å¢é‡ç¼–è¯‘**: å¯é€‰çš„ TypeScript å¢é‡ç¼–è¯‘æ¨¡å¼
- ğŸ› ï¸ **å¤šç§å¼€å‘æ¨¡å¼**: ç›´æ¥è¿è¡Œã€ç›‘å¬ç¼–è¯‘ã€ä»…ç¼–è¯‘ç­‰é€‰é¡¹
- ğŸ—„ï¸ **æ•°æ®åº“é›†æˆ**: å®Œæ•´çš„ MySQL æ•°æ®åº“æ“ä½œå±‚

> ğŸ“– è¯¦ç»†çš„å¼€å‘æŒ‡å—è¯·å‚è€ƒ [docs/development.md](docs/development.md)

## éƒ¨ç½²è¯´æ˜

### 1. æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

- Node.js 16+
- MySQL 5.7+
- PM2ï¼ˆæ¨èç”¨äºè¿›ç¨‹ç®¡ç†ï¼‰

### 2. éƒ¨ç½²æ­¥éª¤

```bash
# 1. å…‹éš†ä»£ç 
git clone <your-repo>
cd TIC-Bot

# 2. å®‰è£…ä¾èµ–
npm install

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶

# 4. åˆå§‹åŒ–æ•°æ®åº“
npm run setup-db

# 5. æ„å»ºé¡¹ç›®
npm run build

# 6. å¯åŠ¨æœåŠ¡ï¼ˆä½¿ç”¨PM2ï¼‰
pm2 start dist/bot/bot.js --name "tic-bot"

# æˆ–ç›´æ¥å¯åŠ¨
npm start
```

### 3. è¿›ç¨‹ç®¡ç†ï¼ˆPM2ï¼‰

```bash
# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs tic-bot

# é‡å¯æœåŠ¡
pm2 restart tic-bot

# åœæ­¢æœåŠ¡
pm2 stop tic-bot
```

## API æ–‡æ¡£

### DatabaseManager ä¸»è¦æ–¹æ³•

```typescript
// ä¿å­˜èµ„æ–™
const resourceId = await db.saveResource(resourceData);

// æŸ¥è¯¢èµ„æ–™
const resource = await db.getResourceById(id);

// æŸ¥è¯¢ç”¨æˆ·æ‰€æœ‰èµ„æ–™
const userResources = await db.getResourcesByUserId(userId);
```

### UploadSessionManager ä¸»è¦æ–¹æ³•

```typescript
// å¼€å§‹æ”¶é›†ä¼šè¯
await sessionManager.startPost(userId, message);

// æ·»åŠ åª’ä½“æ–‡ä»¶
sessionManager.appendMedia(userId, message);

// æ·»åŠ éªŒè¯è§†é¢‘
await sessionManager.addVerification(userId, message);
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“è¿æ¥å¤±è´¥**

   ```bash
   # æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€
   systemctl status mysql

   # æµ‹è¯•æ•°æ®åº“è¿æ¥
   npm run setup-db
   ```

2. **æœºå™¨äººæ— å“åº”**

   ```bash
   # æ£€æŸ¥Tokenæ˜¯å¦æ­£ç¡®
   # æ£€æŸ¥ç½‘ç»œè¿æ¥
   # æŸ¥çœ‹æ—¥å¿—è¾“å‡º
   ```

3. **ç¯å¢ƒå˜é‡é—®é¢˜**
   ```bash
   # ç¡®ä¿.envæ–‡ä»¶å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
   # æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡
   ```

### æ—¥å¿—è°ƒè¯•

é¡¹ç›®åŒ…å«è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼š

- ğŸ†• ä¼šè¯åˆ›å»º
- ğŸ“¸ åª’ä½“æ·»åŠ 
- ğŸ¥ éªŒè¯è§†é¢‘
- âœ… ä¿å­˜æˆåŠŸ
- â° è¶…æ—¶å¤„ç†
- âŒ é”™è¯¯ä¿¡æ¯

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

### å¼€å‘æµç¨‹

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. åˆ›å»º Pull Request

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯

## æ›´æ–°æ—¥å¿—

### v2.0.0 (Latest)

- âœ… å®ç°å®Œæ•´çš„ MySQL æ•°æ®åº“é›†æˆ
- âœ… æ•°æ®åº“è‡ªå¢ ID ä½œä¸ºèµ„æ–™ç¼–å·
- âœ… å®Œå–„çš„ç”¨æˆ·åé¦ˆæœºåˆ¶
- âœ… 60 ç§’è¶…æ—¶å¤„ç†
- âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†
- âœ… æ•°æ®åº“è¿æ¥æ± ç®¡ç†

### v1.0.0

- âœ… åŸºç¡€æœºå™¨äººæ¡†æ¶
- âœ… åª’ä½“ç»„æ”¶é›†åŠŸèƒ½
- âœ… ä¸´æ—¶ç¼–å·ç”Ÿæˆ
